name: Agent Team - Review & PR
on:
  workflow_dispatch:
    inputs:
      spec_path:
        description: 'Chemin de la SPEC'
        required: false
        default: 'specs/feature-template.yaml'

jobs:
  run-team:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Tools (Agent + Ops)
        run: |
          python -m pip install --upgrade pip
          # Installation des outils IA + l'outil 'uv' pour la compil des deps
          pip install ruff bandit langgraph langchain google-genai pip-audit pytest uv

      # ---------------------------------------------------------
      # √âTAPE 1 : L'AGENT (Plan & Code)
      # ---------------------------------------------------------
      - name: Agent Team (Plan & Code)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          SPEC="${{ github.event.inputs.spec_path }}"
          if [ -z "$SPEC" ]; then SPEC="specs/feature-template.yaml"; fi
          python orchestrator/langgraph_team.py "$SPEC"

      # ---------------------------------------------------------
      # √âTAPE 2 : APPLICATION & COMPILATION (Ops S√©quentiel)
      # ---------------------------------------------------------
      - name: Apply Diffs & Compile Deps
        run: |
          git config user.email "agent-team[bot]@users.noreply.github.com"
          git config user.name "agent-team[bot]"
          BR="agent/update-${{ github.run_id }}"
          git checkout -b "$BR"

          # 1. Appliquer les modifications de code de l'agent
          if [ -f diffs.json ]; then
            python .github/workflows/scripts/apply_diffs.py
          fi

          # 2. Compilation auto des requirements (Si requirements.in existe)
          # C'est ici qu'on r√©sout ton probl√®me de synchro
          if [ -f requirements.in ]; then
             echo "Compiling requirements with uv..."
             uv pip compile requirements.in -o requirements.txt
          fi

      # ---------------------------------------------------------
      # √âTAPE 3 : AUDIT & LINT (Qualit√© apr√®s modifs)
      # ---------------------------------------------------------
      - name: Post-Code Quality Check
        run: |
          # Lint & Fix auto (Black/Isort via Ruff)
          ruff format . || true
          ruff check --fix . || true
          
          # Audit de s√©curit√©
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt -f json -o pip_audit.json || true
          fi

      # ---------------------------------------------------------
      # √âTAPE 4 : COMMIT & PR
      # ---------------------------------------------------------
      - name: Push & Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # On ajoute tout : code agent + requirements compil√©s + fixes du linter
          git add -A
          
          if [[ -n $(git status -s) ]]; then
            git commit -m "feat(agent): update 2026 (auto-compiled & linted)"
            git push --force --set-upstream origin "agent/update-${{ github.run_id }}"
            
            gh pr create -B main -H "agent/update-${{ github.run_id }}" \
              --title "ü§ñ Agent Team: Update 2026" \
              --body "PR g√©n√©r√©e automatiquement.\n\n- Scope: ${{ github.event.inputs.spec_path }}\n- Deps: Compil√©es via uv\n- Style: Corrig√© via Ruff" \
              || echo "PR d√©j√† existante."
          else
            echo "Aucun changement d√©tect√©."
          fi